# FocusBond EVM 测试指南

## 测试前准备

### 1. 启动 Anvil 本地节点
```bash
# 在项目根目录运行
./run.sh
# 或者
anvil
```

### 2. 部署合约
```bash
# 确保合约已部署到本地网络
# 查看部署的合约地址是否与配置文件中的一致
```

### 3. 启动前端开发服务器
```bash
cd apps/web
pnpm install  # 首次运行需要安装依赖
pnpm dev
```

### 4. 配置 MetaMask
- 添加 Anvil Local 网络
  - 网络名称: Anvil Local
  - RPC URL: http://127.0.0.1:8545
  - Chain ID: 31337
  - 货币符号: ETH
  
- 导入测试账户 (可选)
  - 私钥: `0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80`
  - 地址: `0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266`

## 功能测试清单

### ✅ 1. 钱包连接测试
- [ ] 打开 `http://localhost:3000/dashboard-evm`
- [ ] 点击 "Connect Wallet" 按钮
- [ ] 选择 MetaMask
- [ ] 确认连接请求
- [ ] 验证钱包地址显示正确
- [ ] 验证合约地址显示正确

### ✅ 2. 余额显示测试
- [ ] 验证 ETH 余额显示正确
- [ ] 验证 FCRED (专注积分) 余额显示
- [ ] 验证基础费用信息显示

### ✅ 3. 创建会话测试
#### 3.1 参数验证测试
- [ ] 输入无效时长 (0, -1, 99999)，验证错误提示
- [ ] 输入无效质押金额 (0, -1, 0.0001)，验证错误提示
- [ ] 输入有效参数，验证可以创建会话

#### 3.2 正常创建流程
- [ ] 输入时长: 60 分钟
- [ ] 输入质押: 0.1 ETH
- [ ] 点击 "创建会话" 按钮
- [ ] 在 MetaMask 中确认交易
- [ ] 等待交易确认
- [ ] 验证交易成功提示
- [ ] 验证会话卡片显示

### ✅ 4. 会话倒计时测试
- [ ] 验证倒计时正常运行 (HH:MM:SS 格式)
- [ ] 验证倒计时每秒更新
- [ ] 验证剩余时间准确

### ✅ 5. 心跳功能测试
- [ ] 等待 2 分钟以上
- [ ] 验证心跳警告显示 "⚠️ 需要发送心跳信号"
- [ ] 点击 "💓 心跳" 按钮
- [ ] 在 MetaMask 中确认交易
- [ ] 验证心跳发送成功提示
- [ ] 验证 "上次心跳" 时间更新

### ✅ 6. 费用计算测试
- [ ] 验证会话信息卡片显示
  - [ ] 运行时间
  - [ ] 完成度百分比
  - [ ] 剩余时间
  - [ ] 质押金额
  
- [ ] 验证中断惩罚卡片显示
  - [ ] 中断费用金额
  - [ ] 费用倍数计算正确
  - [ ] 随时间增长费用增加

- [ ] 等待 10 分钟，验证费用倍数从 1x 增加到 1.2x
- [ ] 等待 20 分钟，验证费用倍数增加到 1.4x

### ✅ 7. 中断会话测试
- [ ] 创建一个新会话
- [ ] 等待几分钟
- [ ] 点击 "中断会话" 按钮
- [ ] 验证确认弹窗显示
  - [ ] 惩罚费用金额
  - [ ] 完成度百分比
- [ ] 确认中断
- [ ] 在 MetaMask 中确认交易
- [ ] 验证交易成功
- [ ] 验证 FCRED 余额减少
- [ ] 验证会话状态更新

### ✅ 8. 完成会话测试
- [ ] 创建一个短时间会话 (如 1 分钟)
- [ ] 等待倒计时结束
- [ ] 验证 "可完成" 状态显示
- [ ] 验证完成奖励卡片显示
  - [ ] 奖励金额
  - [ ] 质押返还金额
- [ ] 点击 "完成会话" 按钮
- [ ] 验证确认弹窗显示正确信息
- [ ] 确认完成
- [ ] 在 MetaMask 中确认交易
- [ ] 验证交易成功
- [ ] 验证 ETH 余额增加
- [ ] 验证质押金返还
- [ ] 验证会话状态更新

### ✅ 9. 费用计算 API 测试
- [ ] 创建一个活跃会话
- [ ] 打开浏览器开发者工具
- [ ] 查看 Network 标签
- [ ] 验证每 5 秒调用一次 `/api/session/calculate-fee`
- [ ] 验证 API 响应包含正确数据
  - [ ] session 信息
  - [ ] timing 信息
  - [ ] fees 信息
  - [ ] rewards 信息

### ✅ 10. 错误处理测试
- [ ] 断开钱包连接，验证错误提示
- [ ] 网络切换到其他链，验证错误提示
- [ ] 余额不足时创建会话，验证错误提示
- [ ] FCRED 余额不足时中断会话，验证错误提示
- [ ] 拒绝 MetaMask 交易，验证错误处理

### ✅ 11. 界面响应测试
- [ ] 验证交易提交时按钮禁用
- [ ] 验证交易确认时显示 "处理中..." 状态
- [ ] 验证交易成功后按钮恢复
- [ ] 验证错误消息正确显示
- [ ] 验证交易哈希正确显示

### ✅ 12. 多会话测试
- [ ] 完成一个会话
- [ ] 立即创建新会话
- [ ] 验证费用计算重置
- [ ] 验证新会话正常运行

## 性能测试

### 会话刷新性能
- [ ] 验证会话数据每秒刷新不影响性能
- [ ] 验证费用计算 API 每 5 秒调用不影响性能
- [ ] 验证倒计时更新流畅

### 内存测试
- [ ] 让会话运行 1 小时
- [ ] 验证内存使用正常
- [ ] 验证没有内存泄漏

## 边界情况测试

### 时间边界
- [ ] 创建 1 分钟会话，验证正常
- [ ] 创建 100 分钟会话，验证正常
- [ ] 创建 1000 分钟会话，验证正常

### 金额边界
- [ ] 质押 0.001 ETH (最小值)，验证正常
- [ ] 质押 1 ETH，验证正常
- [ ] 质押 10 ETH，验证正常

### 费用增长
- [ ] 运行会话超过 30 分钟
- [ ] 验证费用倍数正确 (1.6x)
- [ ] 验证中断费用计算正确

## 已知问题

- 暂无

## 测试结果记录

| 测试项 | 状态 | 备注 |
|--------|------|------|
| 钱包连接 | ⬜ | |
| 余额显示 | ⬜ | |
| 创建会话 | ⬜ | |
| 倒计时 | ⬜ | |
| 心跳功能 | ⬜ | |
| 费用计算 | ⬜ | |
| 中断会话 | ⬜ | |
| 完成会话 | ⬜ | |
| API 调用 | ⬜ | |
| 错误处理 | ⬜ | |

说明：
- ⬜ 待测试
- ✅ 测试通过
- ❌ 测试失败

## 测试报告模板

```
测试日期: YYYY-MM-DD
测试人员: 
测试环境:
- Node.js 版本: 
- Anvil 版本:
- 浏览器: 
- MetaMask 版本:

测试结果总结:
- 通过项: X/12
- 失败项: X/12
- 待修复问题: X

详细问题:
1. [问题描述]
   - 复现步骤:
   - 预期结果:
   - 实际结果:
   - 截图:

建议:
1. [建议内容]
```

## 自动化测试计划

未来可以考虑添加以下自动化测试：
1. 单元测试 (Jest + React Testing Library)
2. 集成测试 (Cypress)
3. 合约交互测试 (Hardhat/Foundry)
4. E2E 测试 (Playwright)

