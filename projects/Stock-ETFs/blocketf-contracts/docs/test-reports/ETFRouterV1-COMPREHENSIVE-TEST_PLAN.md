# ETFRouterV1 综合测试计划 - 完整版

## 执行摘要

本测试计划为 ETFRouterV1 合约设计了 **450+ 个测试用例**，确保实现 100% 的代码覆盖率。该计划基于合约的 1290 行代码，覆盖所有函数、分支、边界条件和集成场景。

## 合约分析

### 代码统计
- **总行数**: 1290
- **公开函数**: 20 个
- **内部函数**: 25 个
- **修饰符**: 1 个
- **事件**: 4 个
- **错误定义**: 8 个
- **状态变量**: 8 个
- **常量**: 5 个

### 复杂度评估
- **圈复杂度**: ~120（高复杂度）
- **分支点**: 85+
- **循环结构**: 12
- **Try-Catch块**: 15
- **外部调用**: 40+

## 测试分类和用例

### 1. 构造函数和初始化测试 (15个用例)

#### 1.1 基础初始化测试
- TC-001: 正常参数初始化
- TC-002: 零地址参数验证（每个参数）
- TC-003: 相同地址参数验证
- TC-004: Owner权限初始化
- TC-005: 默认值设置验证

#### 1.2 Immutable变量测试
- TC-006: etfCore正确设置
- TC-007: v3Router正确设置
- TC-008: priceOracle正确设置
- TC-009: v2Router正确设置
- TC-010: quoterV3正确设置
- TC-011: USDT地址正确设置

#### 1.3 初始状态测试
- TC-012: defaultSlippage = 300
- TC-013: defaultPoolFee = 2500
- TC-014: WBNB默认使用V2
- TC-015: 合约未暂停状态

### 2. mintExactShares 函数测试 (60个用例)

#### 2.1 正常流程测试
- TC-016: 单一资产ETF铸造
- TC-017: 双资产ETF铸造
- TC-018: 三资产ETF铸造
- TC-019: 五资产ETF铸造
- TC-020: 十资产ETF铸造
- TC-021: 包含USDT的ETF铸造
- TC-022: 不包含USDT的ETF铸造
- TC-023: 最小份额铸造(1 wei)
- TC-024: 最大份额铸造(type(uint256).max)
- TC-025: 精确USDT使用量

#### 2.2 路由器选择测试
- TC-026: 全部使用V2路由
- TC-027: 全部使用V3路由
- TC-028: 混合V2/V3路由
- TC-029: V2路由失败处理
- TC-030: V3路由失败处理

#### 2.3 Pool配置测试
- TC-031: 使用配置的V3 Pool
- TC-032: 无配置Pool回退
- TC-033: 多费率尝试(0.05%)
- TC-034: 多费率尝试(0.25%)
- TC-035: 多费率尝试(1%)

#### 2.4 USDT处理测试
- TC-036: USDT不被swap
- TC-037: USDT正确计数
- TC-038: USDT余额处理
- TC-039: USDT退款计算
- TC-040: USDT精确使用

#### 2.5 授权管理测试
- TC-041: 每个资产授权设置
- TC-042: 授权后清零
- TC-043: 授权覆盖测试
- TC-044: 零数量不授权
- TC-045: forceApprove使用

#### 2.6 退款机制测试
- TC-046: 正常退款
- TC-047: 零退款
- TC-048: 全额退款
- TC-049: 退款事件验证
- TC-050: 退款地址验证

#### 2.7 边界条件测试
- TC-051: shares = 0
- TC-052: maxUSDT = 0
- TC-053: shares = 1
- TC-054: maxUSDT = 1
- TC-055: shares > totalSupply

#### 2.8 时间验证测试
- TC-056: deadline刚好到期
- TC-057: deadline已过期
- TC-058: deadline = 0
- TC-059: deadline = type(uint256).max
- TC-060: block.timestamp边界

#### 2.9 状态检查测试
- TC-061: 暂停状态调用
- TC-062: 恢复后调用
- TC-063: 重入保护测试
- TC-064: 多次调用测试
- TC-065: 并发调用测试

#### 2.10 事件发射测试
- TC-066: SharesMinted完整参数
- TC-067: 事件顺序验证
- TC-068: 多事件验证
- TC-069: 事件数据准确性
- TC-070: Gas消耗记录

#### 2.11 异常处理测试
- TC-071: USDT转账失败
- TC-072: ETF mint失败
- TC-073: Swap失败处理
- TC-074: 授权失败处理
- TC-075: 余额不足处理

### 3. mintWithUSDT 函数测试 (55个用例)

#### 3.1 基础功能测试
- TC-076: 标准USDT铸造
- TC-077: 最小USDT铸造
- TC-078: 最大USDT铸造
- TC-079: minShares保护
- TC-080: 份额计算准确性

#### 3.2 比例计算测试
- TC-081: 单一资产比例
- TC-082: 均等比例
- TC-083: 不均等比例
- TC-084: 极端比例(99:1)
- TC-085: 动态比例调整

#### 3.3 预算分配测试
- TC-086: 精确预算分配
- TC-087: 舍入误差处理
- TC-088: 预算总和验证
- TC-089: 零预算处理
- TC-090: 溢出保护

#### 3.4 资产购买测试
- TC-091: V2精确输入购买
- TC-092: V3精确输入购买
- TC-093: 混合购买策略
- TC-094: 购买失败回滚
- TC-095: 部分购买成功

#### 3.5 余额处理测试
- TC-096: 余额计算准确
- TC-097: 余额全部售回
- TC-098: USDT余额直接退
- TC-099: 混合余额处理
- TC-100: 零余额处理

#### 3.6 滑点保护测试
- TC-101: 正常滑点范围
- TC-102: 极限滑点测试
- TC-103: 零滑点测试
- TC-104: 滑点超限拒绝
- TC-105: 动态滑点调整

#### 3.7 转账和授权测试
- TC-106: USDT transferFrom
- TC-107: 资产转给Core
- TC-108: 退款转账验证
- TC-109: 授权管理验证
- TC-110: 批量转账优化

#### 3.8 Oracle集成测试
- TC-111: Oracle价格获取
- TC-112: 价格为零处理
- TC-113: 价格精度验证
- TC-114: 多资产价格
- TC-115: Oracle失败回退

#### 3.9 事件和日志测试
- TC-116: MintWithUSDT事件
- TC-117: 完整参数记录
- TC-118: Gas使用记录
- TC-119: 错误日志验证
- TC-120: 性能指标记录

#### 3.10 集成场景测试
- TC-121: 低流动性处理
- TC-122: 高波动性处理
- TC-123: 多用户并发
- TC-124: 大额交易处理
- TC-125: 小额交易优化
- TC-126: 紧急情况处理
- TC-127: 恢复机制测试
- TC-128: 升级兼容性
- TC-129: 跨链场景模拟
- TC-130: 压力测试

### 4. burnToUSDT 函数测试 (50个用例)

#### 4.1 基础销毁测试
- TC-131: 标准份额销毁
- TC-132: 最小份额销毁
- TC-133: 最大份额销毁
- TC-134: 部分份额销毁
- TC-135: 全部份额销毁

#### 4.2 份额转移测试
- TC-136: transferFrom验证
- TC-137: 授权检查
- TC-138: 余额验证
- TC-139: 零份额处理
- TC-140: 溢出保护

#### 4.3 资产接收测试
- TC-141: 单一资产接收
- TC-142: 多资产接收
- TC-143: 包含USDT接收
- TC-144: 数量验证
- TC-145: 顺序验证

#### 4.4 Swap到USDT测试
- TC-146: V2 swap测试
- TC-147: V3 swap测试
- TC-148: 混合swap测试
- TC-149: USDT跳过swap
- TC-150: 零数量跳过

#### 4.5 输出验证测试
- TC-151: 最小输出保护
- TC-152: 精确输出计算
- TC-153: 滑点扣除验证
- TC-154: 累加准确性
- TC-155: 最终转账验证

#### 4.6 异常处理测试
- TC-156: 份额不足
- TC-157: 授权不足
- TC-158: Burn失败
- TC-159: Swap失败
- TC-160: 转账失败

#### 4.7 事件测试
- TC-161: BurnToUSDT事件
- TC-162: 参数准确性
- TC-163: 时间戳记录
- TC-164: Gas消耗
- TC-165: 多事件顺序

#### 4.8 边界测试
- TC-166: shares = 0
- TC-167: minUSDT = 0
- TC-168: minUSDT > 预期
- TC-169: deadline过期
- TC-170: 重入攻击

#### 4.9 集成测试
- TC-171: 完整销毁流程
- TC-172: 部分失败恢复
- TC-173: 多用户并发
- TC-174: 极端市场条件
- TC-175: 紧急暂停恢复

#### 4.10 性能测试
- TC-176: Gas优化验证
- TC-177: 大量资产处理
- TC-178: 循环优化验证
- TC-179: 缓存使用验证
- TC-180: 批处理优化

### 5. 估算函数测试 (45个用例)

#### 5.1 usdtNeededForShares测试
- TC-181: 单一资产估算
- TC-182: 多资产估算
- TC-183: 包含USDT估算
- TC-184: V2报价使用
- TC-185: V3报价使用
- TC-186: 零份额估算
- TC-187: 大额估算精度
- TC-188: 报价失败处理
- TC-189: Oracle回退
- TC-190: 累加准确性

#### 5.2 usdtToShares测试
- TC-191: 标准转换
- TC-192: 最小金额转换
- TC-193: 最大金额转换
- TC-194: 比例计算验证
- TC-195: 预算分配验证
- TC-196: V2估算路径
- TC-197: V3估算路径
- TC-198: 混合估算
- TC-199: 零输入处理
- TC-200: 精度验证

#### 5.3 sharesToUsdt测试
- TC-201: 标准转换
- TC-202: 单一资产转换
- TC-203: 多资产转换
- TC-204: USDT直接计算
- TC-205: DEX报价使用
- TC-206: Oracle回退
- TC-207: 最佳报价选择
- TC-208: 零份额处理
- TC-209: 溢出保护
- TC-210: 精度保证

#### 5.4 getAssetV3Pool测试
- TC-211: 配置池返回
- TC-212: 默认费率返回
- TC-213: 零地址处理
- TC-214: 费率提取验证
- TC-215: 多池查询

#### 5.5 估算精度测试
- TC-216: 小数位精度
- TC-217: 舍入误差
- TC-218: 大数处理
- TC-219: 极小值处理
- TC-220: 一致性验证

#### 5.6 性能基准测试
- TC-221: 单次估算耗时
- TC-222: 批量估算性能
- TC-223: 缓存效果
- TC-224: Gas消耗对比
- TC-225: 优化验证

### 6. 管理函数测试 (40个用例)

#### 6.1 setDefaultSlippage测试
- TC-226: 正常设置(100)
- TC-227: 正常设置(300)
- TC-228: 最大值设置(500)
- TC-229: 超限拒绝(501)
- TC-230: 零值设置
- TC-231: 权限验证
- TC-232: 事件发射
- TC-233: 状态更新验证

#### 6.2 setDefaultPoolFee测试
- TC-234: 设置FEE_LOW(500)
- TC-235: 设置FEE_MEDIUM(2500)
- TC-236: 设置FEE_HIGH(10000)
- TC-237: 无效费率(1000)
- TC-238: 零费率测试
- TC-239: 权限检查
- TC-240: 更新验证

#### 6.3 setAssetV3Pool测试
- TC-241: 有效池设置
- TC-242: 零地址清除
- TC-243: 池验证(token0)
- TC-244: 池验证(token1)
- TC-245: 错误池拒绝
- TC-246: 事件验证
- TC-247: 覆盖更新
- TC-248: 批量关联测试

#### 6.4 setAssetV3PoolsBatch测试
- TC-249: 批量设置成功
- TC-250: 数组长度不匹配
- TC-251: 包含零地址资产
- TC-252: 部分无效池
- TC-253: 全部有效验证
- TC-254: 事件批量发射
- TC-255: Gas优化验证

#### 6.5 setAssetUseV2Router测试
- TC-256: 设置使用V2
- TC-257: 设置使用V3
- TC-258: 切换路由器
- TC-259: 零地址拒绝
- TC-260: 批量设置模拟
- TC-261: 状态持久化
- TC-262: 权限验证

#### 6.6 pause/unpause测试
- TC-263: 正常暂停
- TC-264: 重复暂停
- TC-265: 正常恢复
- TC-266: 未暂停恢复
- TC-267: 权限验证
- TC-268: 功能阻断验证

#### 6.7 recoverToken测试
- TC-269: ERC20恢复
- TC-270: USDT恢复
- TC-271: ETF份额恢复
- TC-272: 零数量处理
- TC-273: 余额验证
- TC-274: 权限检查
- TC-275: 转账验证

### 7. V2 Swap函数测试 (35个用例)

#### 7.1 _v2BuyAssetExactOutput测试
- TC-276: 标准购买
- TC-277: 最小数量购买
- TC-278: 最大数量购买
- TC-279: USDT余额验证
- TC-280: 授权设置验证
- TC-281: 授权清理验证
- TC-282: Swap失败处理
- TC-283: 路径构建验证
- TC-284: 返回值验证
- TC-285: Gas消耗测试

#### 7.2 _v2BuyAssetExactInput测试
- TC-286: 精确USDT输入
- TC-287: 零滑点接受
- TC-288: 路径验证
- TC-289: 授权管理
- TC-290: 失败revert
- TC-291: 输出数量验证
- TC-292: 时间戳验证

#### 7.3 _v2SellAssetExactInput测试
- TC-293: 标准销售
- TC-294: 全部余额销售
- TC-295: 部分余额销售
- TC-296: 授权验证
- TC-297: 路径反向验证
- TC-298: 失败返回0
- TC-299: USDT接收验证
- TC-300: 事件监控

#### 7.4 V2集成测试
- TC-301: 买卖往返测试
- TC-302: 滑点累计测试
- TC-303: 多资产连续swap
- TC-304: 流动性不足处理
- TC-305: 价格冲击测试
- TC-306: MEV保护验证
- TC-307: 三明治攻击防护
- TC-308: 闪电贷集成
- TC-309: 路由优化验证
- TC-310: 失败恢复机制

### 8. V3 Swap函数测试 (45个用例)

#### 8.1 _v3BuyAssetExactOutput测试
- TC-311: 配置池购买
- TC-312: 多费率尝试
- TC-313: 最优费率选择
- TC-314: 授权管理验证
- TC-315: 失败处理机制

#### 8.2 _v3BuyAssetExactInput测试
- TC-316: 标准输入购买
- TC-317: 配置池使用
- TC-318: 费率遍历逻辑
- TC-319: 输出验证
- TC-320: Gas优化验证

#### 8.3 _v3ExecuteExactInput测试
- TC-321: 参数构建验证
- TC-322: 费率设置验证
- TC-323: recipient验证
- TC-324: deadline验证
- TC-325: sqrtPriceLimitX96

#### 8.4 _v3ExecuteExactOutput测试
- TC-326: 精确输出执行
- TC-327: 最大输入限制
- TC-328: 参数验证
- TC-329: 失败revert
- TC-330: 返回值验证

#### 8.5 _v3TryMultipleFeesExactInput测试
- TC-331: 费率优先级验证
- TC-332: 首次成功返回
- TC-333: 全部失败处理
- TC-334: 部分成功场景
- TC-335: Gas消耗对比

#### 8.6 _v3TryMultipleFeesExactOutput测试
- TC-336: 多费率尝试逻辑
- TC-337: 最优选择验证
- TC-338: 失败继续机制
- TC-339: 最终失败revert
- TC-340: 性能优化验证

#### 8.7 _v3ExecuteSellForUSDT测试
- TC-341: 标准销售执行
- TC-342: 费率使用验证
- TC-343: 授权管理
- TC-344: 失败返回0
- TC-345: USDT接收验证

#### 8.8 _getV3QuoteSimple测试
- TC-346: 配置池报价
- TC-347: 多费率报价
- TC-348: 最优报价选择
- TC-349: Oracle回退
- TC-350: 报价准确性

#### 8.9 V3高级特性测试
- TC-351: 范围订单模拟
- TC-352: 流动性聚合
- TC-353: 滑点优化
- TC-354: 路径优化
- TC-355: 多跳路由

### 9. 辅助函数测试 (35个用例)

#### 9.1 _calculateActualAssetRatios测试
- TC-356: 均等比例计算
- TC-357: 不均等比例
- TC-358: 单一资产100%
- TC-359: 零储备处理
- TC-360: 总和验证(10000)
- TC-361: 价格获取验证
- TC-362: 精度处理
- TC-363: 溢出保护

#### 9.2 _buyAssetWithExactUSDT测试
- TC-364: V2路径选择
- TC-365: V3路径选择
- TC-366: 零输入处理
- TC-367: 路由切换验证
- TC-368: 返回值验证

#### 9.3 _handleRemaindersAsUSDT测试
- TC-369: 单一余额处理
- TC-370: 多余额处理
- TC-371: USDT直接累加
- TC-372: 其他资产销售
- TC-373: 零余额跳过
- TC-374: 退款执行验证
- TC-375: 事件发射验证

#### 9.4 _estimateAssetToUSDTOutput测试
- TC-376: V2估算路径
- TC-377: V3估算路径
- TC-378: 配置池估算
- TC-379: 多费率最优
- TC-380: Oracle回退
- TC-381: 零输入处理
- TC-382: USDT直接返回

#### 9.5 _estimateAssetFromUSDT测试
- TC-383: V2报价获取
- TC-384: V3报价获取
- TC-385: 最优报价选择
- TC-386: Oracle回退逻辑
- TC-387: 精度验证
- TC-388: 性能基准
- TC-389: 缓存效果
- TC-390: 批量估算

### 10. 修饰符和错误测试 (20个用例)

#### 10.1 withinDeadline修饰符测试
- TC-391: 正常通过
- TC-392: 刚好到期
- TC-393: 已过期拒绝
- TC-394: 零值处理
- TC-395: 最大值处理

#### 10.2 错误处理测试
- TC-396: TransactionExpired
- TC-397: ZeroAmount
- TC-398: InsufficientOutput
- TC-399: InvalidSlippage
- TC-400: InvalidAsset
- TC-401: PoolNotFound
- TC-402: SwapFailed
- TC-403: InvalidPrice

#### 10.3 重入保护测试
- TC-404: 直接重入攻击
- TC-405: 间接重入攻击
- TC-406: 跨函数重入
- TC-407: 回调重入
- TC-408: 状态一致性

#### 10.4 权限验证测试
- TC-409: onlyOwner验证
- TC-410: 权限转移测试
- TC-411: 零地址owner
- TC-412: 多签模拟

### 11. 集成和端到端测试 (30个用例)

#### 11.1 完整生命周期测试
- TC-413: 铸造→持有→销毁
- TC-414: 多次铸造累积
- TC-415: 部分销毁循环
- TC-416: 紧急暂停恢复
- TC-417: 配置更新影响

#### 11.2 多用户场景测试
- TC-418: 10用户并发铸造
- TC-419: 100用户压力测试
- TC-420: 交替铸造销毁
- TC-421: 竞争条件处理
- TC-422: 公平性验证

#### 11.3 极端市场测试
- TC-423: 价格暴涨场景
- TC-424: 价格暴跌场景
- TC-425: 流动性枯竭
- TC-426: Gas价格极高
- TC-427: 网络拥堵模拟

#### 11.4 攻击向量测试
- TC-428: 价格操纵攻击
- TC-429: 抢先交易攻击
- TC-430: 三明治攻击
- TC-431: 闪电贷攻击
- TC-432: 时间操纵攻击

#### 11.5 升级和迁移测试
- TC-433: 状态迁移验证
- TC-434: 向后兼容性
- TC-435: 紧急升级流程
- TC-436: 数据完整性
- TC-437: 功能延续性

#### 11.6 性能基准测试
- TC-438: TPS压力测试
- TC-439: 内存使用分析
- TC-440: 存储优化验证
- TC-441: 计算复杂度
- TC-442: 网络带宽影响

### 12. 模糊测试和属性测试 (15个用例)

#### 12.1 输入模糊测试
- TC-443: 随机金额输入
- TC-444: 随机地址输入
- TC-445: 随机时间戳
- TC-446: 组合参数模糊
- TC-447: 边界值组合

#### 12.2 状态属性测试
- TC-448: 余额守恒定律
- TC-449: 份额总量一致
- TC-450: 价格单调性
- TC-451: 滑点上限保证
- TC-452: 授权清理保证

#### 12.3 不变量测试
- TC-453: USDT总量守恒
- TC-454: 无资产泄露
- TC-455: 无状态污染
- TC-456: 事件完整性
- TC-457: 错误可恢复性

## 测试执行计划

### 阶段一：单元测试 (第1-2周)
- 完成所有独立函数测试
- 达到95%行覆盖率
- 修复发现的bug

### 阶段二：集成测试 (第3周)
- 完成端到端流程测试
- 验证外部依赖集成
- 性能基准建立

### 阶段三：安全测试 (第4周)
- 执行所有攻击向量测试
- 模糊测试运行72小时
- 静态分析工具扫描

### 阶段四：压力测试 (第5周)
- 主网fork环境测试
- 1000+ TPS压力测试
- 极端场景验证

## 测试环境要求

### 硬件要求
- CPU: 8核以上
- RAM: 16GB以上
- SSD: 100GB可用空间

### 软件要求
```bash
# 测试框架
- Foundry (最新版)
- Hardhat 2.12+
- Truffle 5.5+

# 分析工具
- Slither 0.9+
- Mythril 0.23+
- Echidna 2.0+

# 辅助工具
- Tenderly
- Ganache
- Anvil
```

## 测试数据准备

### Mock合约
1. MockETFCore (完整功能模拟)
2. MockPriceOracle (价格场景模拟)
3. MockV2Router (DEX V2模拟)
4. MockV3Router (DEX V3模拟)
5. MockQuoterV3 (报价模拟)
6. MockERC20 (代币模拟)

### 测试数据集
```solidity
// 标准测试参数
TestParams {
    standardAmount: 1000e18,
    minAmount: 1,
    maxAmount: type(uint256).max,
    standardShares: 100e18,
    standardDeadline: block.timestamp + 3600,
    addresses: [alice, bob, charlie, ...],
    assets: [USDT, WBNB, BTCB, ETH, ...],
    poolFees: [500, 2500, 10000]
}
```

## 覆盖率要求

### 最低要求
- 行覆盖率: 100%
- 分支覆盖率: 100%
- 函数覆盖率: 100%
- 语句覆盖率: 100%

### 质量指标
- 断言密度: >2.0
- 圈复杂度覆盖: 100%
- 路径覆盖: >95%
- 边界值覆盖: 100%

## 风险矩阵

| 风险类别 | 风险等级 | 测试用例数 | 缓解措施 |
|---------|---------|-----------|---------|
| 资金安全 | 极高 | 80+ | 多重验证、形式化验证 |
| 价格操纵 | 高 | 40+ | 预言机验证、滑点保护 |
| 流动性风险 | 中 | 30+ | 多路径、费率遍历 |
| Gas超限 | 中 | 20+ | 优化验证、批处理 |
| 升级风险 | 低 | 15+ | 兼容性测试 |

## 测试报告模板

```markdown
## ETFRouterV1 测试报告

### 执行摘要
- 日期: YYYY-MM-DD
- 版本: X.X.X
- 执行用例: XXX/457
- 通过率: XX%
- 覆盖率: XX%

### 关键发现
1. [高优先级问题]
2. [中优先级问题]
3. [低优先级改进]

### 性能指标
- 平均Gas: XXX
- 最大Gas: XXX
- TPS: XXX

### 建议
[改进建议列表]

### 附录
[详细测试日志]
```

## 持续集成配置

```yaml
# .github/workflows/test.yml
name: ETFRouterV1 Tests
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
      - name: Run tests
        run: forge test --match-contract ETFRouterV1
      - name: Check coverage
        run: forge coverage --match-contract ETFRouterV1
      - name: Generate report
        run: ./scripts/generate-report.sh
```

## 审计准备清单

- [ ] 所有测试通过
- [ ] 100%覆盖率达成
- [ ] 静态分析无高危问题
- [ ] 模糊测试72小时无异常
- [ ] 形式化验证完成
- [ ] Gas优化验证
- [ ] 文档完整性
- [ ] 部署脚本就绪
- [ ] 监控方案确定
- [ ] 应急预案制定

## 总结

本测试计划包含 **457个测试用例**，覆盖了 ETFRouterV1 合约的所有功能、分支、边界条件和潜在风险。通过系统化的测试执行，可以确保合约的安全性、可靠性和性能达到生产环境要求。

测试执行预计需要5周时间，建议配备3-4名测试工程师并行执行，以确保测试质量和进度。

---

*文档版本: 2.0.0*
*最后更新: 2025-09-29*
*状态: 待执行*
*负责人: BlockETF测试团队*