# Network Configuration Guide

This guide explains how to deploy and run Ponymarket on different networks.

## Supported Networks

- **localhost** - Local Hardhat node (Chain ID: 31337)
- **hashkeyTestnet** - HashKey Chain Testnet (Chain ID: 133)

## Quick Start

### 1. Deploy to HashKey Chain Testnet

```bash
# 1. Set your private key in hardhat-bribe/.env
echo "PRIVATE_KEY=your_private_key_here" > hardhat-bribe/.env

# 2. Deploy contracts
cd hardhat-bribe
npx hardhat ignition deploy ignition/modules/Deploy.ts --network hashkeyTestnet

# 3. Export ABIs and addresses
npm run export-abis hashkeyTestnet

# 4. Start backend (will auto-connect to HashKey testnet via RPC_URL in .env)
cd ../nestjs-bribe
npm run start:dev

# 5. Start frontend (will auto-connect to HashKey testnet via VITE_NETWORK in .env.local)
cd ../vite-bribe
npm run dev
```

### 2. Deploy to Localhost

```bash
# 1. Start Hardhat node
cd hardhat-bribe
npx hardhat node

# 2. Deploy contracts (in another terminal)
npx hardhat ignition deploy ignition/modules/Deploy.ts --network localhost
npm run export-abis localhost

# 3. Start backend
cd ../nestjs-bribe
npm run start:dev

# 4. Start frontend
cd ../vite-bribe
npm run dev
```

## Environment Variables

### Frontend (`vite-bribe/.env.local`)

Auto-generated by `export-abis` script:

```bash
VITE_NETWORK=hashkey                        # or 'localhost'
VITE_MOCK_CTF_ADDRESS=0x...
VITE_MOCK_USDC_ADDRESS=0x...
VITE_REWARD_TOKEN_ADDRESS=0x...
VITE_STAKING_BRIBE_ADDRESS=0x...
VITE_BRIBE_MANAGER_ADDRESS=0x...
VITE_PONY_PROTOCOL_ADDRESS=0x...
```

### Backend (`nestjs-bribe/.env`)

Auto-generated by `export-abis` script:

```bash
RPC_URL=https://testnet.hsk.xyz             # or http://127.0.0.1:8545
MOCK_CTF_ADDRESS=0x...
MOCK_USDC_ADDRESS=0x...
# ... (rest of contract addresses)
```

### Smart Contracts (`hardhat-bribe/.env`)

Manual configuration required:

```bash
PRIVATE_KEY=your_private_key_here
```

## Adding New Networks

### 1. Update Hardhat Config

Edit `hardhat-bribe/hardhat.config.ts`:

```typescript
networks: {
  yourNetwork: {
    url: "https://rpc.yournetwork.com",
    accounts: process.env.PRIVATE_KEY ? [process.env.PRIVATE_KEY] : [],
    chainId: 12345,
  },
}
```

### 2. Define Chain in Frontend

Edit `vite-bribe/src/config/chains.ts`:

```typescript
export const yourNetwork = defineChain({
  id: 12345,
  name: 'Your Network',
  nativeCurrency: {
    decimals: 18,
    name: 'Token',
    symbol: 'TKN',
  },
  rpcUrls: {
    default: {
      http: ['https://rpc.yournetwork.com'],
    },
  },
  blockExplorers: {
    default: {
      name: 'Explorer',
      url: 'https://explorer.yournetwork.com',
    },
  },
  testnet: true,
});
```

### 3. Update Wagmi Config

Edit `vite-bribe/src/config/wagmi.ts`:

```typescript
const getChains = () => {
  const network = import.meta.env.VITE_NETWORK || 'localhost';

  switch (network) {
    case 'yournetwork':
      return [yourNetwork];
    case 'hashkey':
      return [hashkeyTestnet];
    case 'localhost':
    default:
      return [hardhatLocal];
  }
};
```

### 4. Update Export Script

Edit `hardhat-bribe/scripts/export-abis.ts`:

```typescript
const chainIdMap: Record<string, number> = {
  localhost: 31337,
  hashkeyTestnet: 133,
  yourNetwork: 12345,  // Add here
};
```

And update RPC URL mapping:

```typescript
const rpcUrl = 
  network === 'hashkeyTestnet' ? 'https://testnet.hsk.xyz' :
  network === 'yourNetwork' ? 'https://rpc.yournetwork.com' :
  'http://127.0.0.1:8545';
```

## Network Information

### HashKey Chain Testnet

- **Chain ID**: 133
- **RPC URL**: https://testnet.hsk.xyz
- **Explorer**: https://hashkeychain-testnet-explorer.alt.technology
- **Native Token**: HSK
- **Faucet**: Contact HashKey team

### Localhost

- **Chain ID**: 31337
- **RPC URL**: http://127.0.0.1:8545
- **Native Token**: ETH (unlimited)
- **Reset on restart**: Yes

## Troubleshooting

### Contract addresses not found

Run `export-abis` with the correct network:

```bash
cd hardhat-bribe
npm run export-abis hashkeyTestnet
```

### Frontend showing wrong network

Check `vite-bribe/.env.local` - make sure `VITE_NETWORK` matches your deployment.

Restart Vite dev server after changing `.env.local`.

### Backend not indexing events

Check `nestjs-bribe/.env` - make sure `RPC_URL` points to the correct network.

### MetaMask wrong network

Add the network to MetaMask:
- **Network Name**: HashKey Chain Testnet
- **RPC URL**: https://testnet.hsk.xyz
- **Chain ID**: 133
- **Currency Symbol**: HSK
- **Block Explorer**: https://hashkeychain-testnet-explorer.alt.technology
