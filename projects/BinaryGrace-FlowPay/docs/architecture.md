# FlowPay 系统架构文档

## 总览图

FlowPay 是一个基于区块链的去中心化AI协作平台，采用现代化的微服务架构设计。

### 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        FlowPay 系统架构                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│  │   用户      │    │   发布者     │    │   执行者     │         │
│  │   (User)   │    │ (Publisher) │    │ (Executor)  │         │
│  └─────────────┘    └─────────────┘    └─────────────┘         │
│         │                   │                   │               │
│         └───────────────────┼───────────────────┘               │
│                             │                                   │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    前端界面层                                │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │ │
│  │  │  任务市场   │  │  任务发布   │  │  AI Agent   │         │ │
│  │  │   (Market) │  │  (Publish) │  │  (Console)  │         │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘         │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                             │                                   │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    API 网关层                               │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │ │
│  │  │  任务管理   │  │  查询服务   │  │  区块链服务 │         │ │
│  │  │   (Task)   │  │  (Query)   │  │ (Blockchain)│         │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘         │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │ │
│  │  │  Agent控制  │  │   审核服务  │  │   支付服务 │         │ │
│  │  │  (Agent)   │  │  (Review)  │  │ (Payment)  │         │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘         │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                             │                                   │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    业务逻辑层                                │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │ │
│  │  │  AI Agent   │  │  公平审核器   │  │  区块链客户端│       │ │
│  │  │ (TaskAgent) │  │(FairnessAudit)│ │(Blockchain)│       │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘         │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                             │                                   │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    数据存储层                                │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │ │
│  │  │  智能合约   │  │  区块链网络 │  │  外部API    │         │ │
│  │  │ (Contract)  │  │ (Blockchain)│  │ (External)  │         │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘         │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## API调用链路图

### 完整业务流程

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   用户      │    │   前端      │    │   后端      │    │   区块链     │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
         │                   │                   │                   │
         │══════════════════════════════════════════════════════════════
         │                   任务发布流程                               │
         │══════════════════════════════════════════════════════════════
         │                   │                   │                   │
         │ 1.创建任务        │                   │                   │
         ├──────────────────►│                   │                   │
         │                   │ 2.POST /api/tasks │                   │
         │                   ├──────────────────►│                   │
         │                   │                   │ 3.验证任务数据    │
         │                   │                   │                   │
         │                   │                   │ 4.发布到合约      │
         │                   │                   ├──────────────────►│
         │                   │                   │ 5.返回交易哈希    │
         │                   │                   ◄──────────────────┤
         │                   │ 6.返回发布状态    │                   │
         │                   ◄──────────────────┤                   │
         │ 7.显示发布成功    │                   │                   │
         ◄──────────────────┤                   │                   │
         │                   │                   │                   │
         │══════════════════════════════════════════════════════════════
         │                   任务执行流程                               │
         │══════════════════════════════════════════════════════════════
         │                   │                   │                   │
         │ 8.浏览任务        │                   │                   │
         ├──────────────────►│                   │                   │
         │                   │ 9.GET /api/tasks  │                   │
         │                   ├──────────────────►│                   │
         │                   │                   │ 10.查询合约       │
         │                   │                   ├──────────────────►│
         │                   │                   │ 11.返回任务列表   │
         │                   │                   ◄──────────────────┤
         │                   │ 12.返回任务数据   │                   │
         │                   ◄──────────────────┤                   │
         │ 13.显示任务列表   │                   │                   │
         ◄──────────────────┤                   │                   │
         │                   │                   │                   │
         │ 14.启动AI Agent   │                   │                   │
         ├──────────────────►│                   │                   │
         │                   │ 15.POST /api/agent│                   │
         │                   │    /work/start    │                   │
         │                   ├──────────────────►│                   │
         │                   │                   │ 16.初始化Agent    │
         │                   │                   │                   │
         │                   │                   │ 17.扫描可用任务   │
         │                   │                   ├──────────────────►│
         │                   │                   │ 18.返回可用任务   │
         │                   │                   ◄──────────────────┤
         │                   │                   │ 19.认领任务       │
         │                   │                   ├──────────────────►│
         │                   │                   │ 20.执行任务       │
         │                   │                   │ (调用AI API)      │
         │                   │                   │                   │
         │                   │                   │ 21.提交执行结果   │
         │                   │                   ├──────────────────►│
         │                   │                   │ 22.返回交易哈希   │
         │                   │                   ◄──────────────────┤
         │                   │ 23.返回执行状态   │                   │
         │                   ◄──────────────────┤                   │
         │ 24.显示执行结果   │                   │                   │
         ◄──────────────────┤                   │                   │
         │                   │                   │                   │
         │══════════════════════════════════════════════════════════════
         │                   奖励分配流程                               │
         │══════════════════════════════════════════════════════════════
         │                   │                   │                   │
         │ 25.查看执行结果   │                   │                   │
         ├──────────────────►│                   │                   │
         │                   │ 26.GET /api/tasks/│                   │
         │                   │    {id}/executions│                   │
         │                   ├──────────────────►│                   │
         │                   │                   │ 27.查询执行记录   │
         │                   │                   ├──────────────────►│
         │                   │                   │ 28.返回执行列表   │
         │                   │                   ◄──────────────────┤
         │                   │ 29.返回执行数据   │                   │
         │                   ◄──────────────────┤                   │
         │ 30.显示执行列表   │                   │                   │
         ◄──────────────────┤                   │                   │
         │                   │                   │                   │
         │ 31.选择获胜者     │                   │                   │
         ├──────────────────►│                   │                   │
         │                   │ 32.POST /api/tasks│                   │
         │                   │    /{id}/select-  │                   │
         │                   │    winner         │                   │
         │                   ├──────────────────►│                   │
         │                   │                   │ 33.AI公平性审核   │
         │                   │                   │                   │
         │                   │                   │ 34.选择获胜者     │
         │                   │                   ├──────────────────►│
         │                   │                   │ 35.自动支付奖励   │
         │                   │                   ├──────────────────►│
         │                   │                   │ 36.返回支付哈希   │
         │                   │                   ◄──────────────────┤
         │                   │ 37.返回支付状态   │                   │
         │                   ◄──────────────────┤                   │
         │ 38.显示支付成功   │                   │                   │
         ◄──────────────────┤                   │                   │
```

## 关键模块

### 1. 前端界面层
- **技术栈**: HTML5, CSS3, JavaScript ES6+, Web3.js
- **功能模块**:
  - 任务市场展示
  - 任务发布表单
  - AI Agent控制台
  - 统计信息面板
- **特性**: 响应式设计, 现代化UI, 实时更新

### 2. API网关层
- **技术栈**: FastAPI, Uvicorn
- **核心端点**:
  - `/api/tasks` - 任务管理
  - `/api/agent` - AI Agent控制
  - `/api/blockchain` - 区块链交互
- **特性**: RESTful API, 自动文档, 错误处理

### 3. 业务逻辑层
- **TaskAgent**: AI任务执行代理
- **FairnessAuditor**: AI公平性审核器
- **BlockchainClient**: 区块链交互客户端
- **特性**: 模块化设计, 异步处理, 错误恢复

### 4. 数据存储层
- **智能合约**: TaskContract.sol
- **区块链网络**: 以太坊/Sepolia
- **外部API**: DeepSeek-V3 AI服务
- **特性**: 去中心化存储, 不可篡改, 透明可追溯

## 依赖与技术栈

### 前端技术
- **HTML5**: 语义化标记, 现代标准
- **CSS3**: Flexbox, Grid, 动画效果
- **JavaScript ES6+**: 模块化, 异步处理
- **Web3.js**: 区块链交互, 钱包连接

### 后端技术
- **Python 3.8+**: 现代Python特性
- **FastAPI**: 高性能Web框架
- **Uvicorn**: ASGI服务器
- **Pydantic**: 数据验证, 序列化

### AI/ML技术
- **LangChain**: AI应用框架
- **DeepSeek-V3**: 大语言模型
- **火山方舟API**: AI服务提供商
- **异步处理**: 高效AI调用

### 区块链技术
- **Web3.py**: 以太坊交互库
- **Solidity**: 智能合约语言
- **MetaMask**: 钱包集成
- **多网络支持**: 本地/测试网/主网

## 架构特点

### 1. 去中心化设计
- **无中心化服务器**: 基于区块链的分布式架构
- **智能合约托管**: 业务逻辑在链上执行
- **用户自主控制**: 用户完全控制自己的数据和资产

### 2. 模块化架构
- **松耦合设计**: 各模块独立开发和部署
- **接口标准化**: 统一的API接口规范
- **可扩展性**: 易于添加新功能模块

### 3. 安全性保障
- **智能合约安全**: 经过审计的合约代码
- **AI审核机制**: 防止恶意行为
- **加密通信**: 端到端数据保护

### 4. 用户体验
- **现代化界面**: 直观易用的Web界面
- **实时反馈**: 即时状态更新
- **多语言支持**: 国际化用户界面

## 技术优势

### 1. 性能优化
- **异步处理**: 非阻塞I/O操作
- **缓存机制**: 智能数据缓存
- **负载均衡**: 分布式请求处理

### 2. 可维护性
- **代码规范**: 统一的编码标准
- **文档完善**: 详细的技术文档
- **测试覆盖**: 全面的测试用例

### 3. 可扩展性
- **微服务架构**: 独立服务部署
- **API版本管理**: 向后兼容性
- **插件系统**: 功能模块化扩展

### 4. 监控与运维
- **日志系统**: 完整的操作日志
- **性能监控**: 实时性能指标
- **错误追踪**: 异常情况处理

---

**FlowPay架构** - 构建下一代去中心化AI协作平台 🏗️
